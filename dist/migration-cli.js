!function(t){var e={};function n(r){if(e[r])return e[r].exports;var a=e[r]={i:r,l:!1,exports:{}};return t[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(r,a,function(e){return t[e]}.bind(null,a));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=6)}([function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){t.done?a(t.value):new n(function(e){e(t.value)}).then(o,s)}c((r=r.apply(t,e||[])).next())})},a=this&&this.__generator||function(t,e){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=e.call(t,o)}catch(t){i=[6,t],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=n(2),s=n(3),c=n(4),u=n(5),l=function(){function t(){this._config=void 0,this._sequelize=void 0,this._migrationFolder=void 0}return t.prototype.setup=function(e){return this._config=c(t.defaultOptions,e),this.init(),this},t.prototype.init=function(){this._sequelize=new i(this._config.database),this._migrationFolder=o.resolve(this._config.migrationFolder)},t.prototype.connectToDatabase=function(){return r(this,void 0,void 0,function(){var t=this;return a(this,function(e){switch(e.label){case 0:return[4,this._sequelize.authenticate().then(function(){}).catch(function(e){return t.onError(e)})];case 1:return e.sent(),[2]}})})},t.prototype.getDatabaseMigrationTime=function(t){return r(this,void 0,void 0,function(){var e,n,r;return a(this,function(a){switch(a.label){case 0:return a.trys.push([0,4,,5]),t||(t=1),[4,this.connectToDatabase()];case 1:return a.sent(),e="\n            CREATE TABLE IF NOT EXISTS migrations (\n                id int(11) NOT NULL AUTO_INCREMENT,\n                name varchar(255) NOT NULL,\n                run_on datetime NOT NULL,\n                PRIMARY KEY (id)\n            )",[4,this._sequelize.query(e)];case 2:return a.sent(),void 0,[4,this._sequelize.query("SELECT * FROM migrations order by run_on desc limit "+t,{type:i.QueryTypes.SELECT})];case 3:return(n=a.sent())?[2,n.map(function(t){return t.name})]:[2,[]];case 4:return r=a.sent(),this.onError(r),[3,5];case 5:return[2]}})})},t.prototype.createSqlMigration=function(t,e){return[{path:t,filename:e+"_up.sql",content:""},{path:t,filename:e+"_down.sql",content:""}]},t.prototype.createJsMigration=function(t,e){return[{path:t,filename:e+".js",content:"\n            \nexports.setup = async function(db){\n    return null;\n}\n        \n            \nexports.up = async function(db){\n    return null;\n}\n        \n            \nexports.down = async function(db){\n    return null;\n}\n        \n        "}]},t.prototype.createFile=function(t){var e=o.join(t.path,t.filename);u.existsSync(t.path)||u.mkdirSync(t.path),u.writeFileSync(e,t.content),this._config.logger("Create file "+e)},t.prototype.onError=function(t){this._config.logger("Error : "+t.message)},t.prototype.migrationNameToDate=function(t){var e=new RegExp(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/i),n=t.match(e);if(7==n.length)return new Date(parseInt(n[1]),parseInt(n[2])-1,parseInt(n[3]),parseInt(n[4]),parseInt(n[5]),parseInt(n[6]))},t.prototype.dateToMigrationName=function(t){return s(t).format("YYYYMMDDHHmmss")},t.prototype.execSQLFile=function(t){return r(this,void 0,void 0,function(){var e,n,r,i,s;return a(this,function(a){switch(a.label){case 0:this._config.logger("Execute ["+t+"]"),e=u.readFileSync(o.join(this._migrationFolder,t)).toString(),n=e.replace(/\r\n/gm,"").split(";"),r=0,a.label=1;case 1:if(!(r<n.length))return[3,6];if(""==(i=n[r]).trim())return[3,5];a.label=2;case 2:return a.trys.push([2,4,,5]),[4,this._sequelize.query(i)];case 3:return a.sent(),[3,5];case 4:return s=a.sent(),this.onError(s),[3,5];case 5:return r++,[3,1];case 6:return[2,!0]}})})},t.prototype.execJSFile=function(t){return r(this,void 0,void 0,function(){return a(this,function(e){return this._config.logger("Execute ["+t+"]"),[2,!0]})})},t.prototype.createMigration=function(t,e){var n=this;try{var r=this._migrationFolder,a=s().format("YYYYMMDDHHmmss");"string"==typeof t&&(a+="-"+t),Array.isArray(t)&&(a+="-"+t.join("-"));var i=e;i||(i=this._config.extension);var o=[];"js"==i&&(o=this.createJsMigration(r,a)),"sql"==i&&(o=this.createSqlMigration(r,a)),o.forEach(function(t){return n.createFile(t)})}catch(t){this.onError(t)}},t.prototype.up=function(t){return r(this,void 0,void 0,function(){var e,n,r,i,o,c,l,f=this;return a(this,function(a){switch(a.label){case 0:return a.trys.push([0,11,,12]),t||(t={}),[4,this.connectToDatabase()];case 1:return a.sent(),[4,this.getDatabaseMigrationTime(1)];case 2:e=a.sent(),n=new Date(1900,1,1,0,0,0),r=t.toDate||new Date,e&&e.length>0&&(n=this.migrationNameToDate(e[0])),i=[],u.readdirSync(this._migrationFolder).forEach(function(t){var e=f.migrationNameToDate(t);e&&s(e).isAfter(s(n))&&s(e).isBefore(r)&&i.push(t)}),o=0,a.label=3;case 3:return o<i.length?i[o].match(/\.js$/g)?[4,this.execJSFile(i[o])]:[3,5]:[3,10];case 4:return a.sent(),[3,7];case 5:return i[o].match(/_up\.sql$/g)?[4,this.execSQLFile(i[o])]:[3,7];case 6:a.sent(),a.label=7;case 7:return c="INSERT INTO migrations (name, run_on) VALUES ('"+i[o]+"', '"+s().format("YYYY-MM-DD HH:mm:ss")+"')",[4,this._sequelize.query(c)];case 8:a.sent(),a.label=9;case 9:return o++,[3,3];case 10:return[2,!0];case 11:return l=a.sent(),this.onError(l),[3,12];case 12:return[2]}})})},t.prototype.down=function(t){return r(this,void 0,void 0,function(){var e,n,r,i,o,s;return a(this,function(a){switch(a.label){case 0:return a.trys.push([0,11,,12]),t||(t={}),e=1,[4,this.connectToDatabase().catch(function(t){throw t})];case 1:return a.sent(),[4,this.getDatabaseMigrationTime(e)];case 2:n=a.sent(),r=[],u.readdirSync(this._migrationFolder).forEach(function(t){n.find(function(e){return e.replace("_up.sql","_down.sql")==t})&&r.push(t)}),i=0,a.label=3;case 3:return i<r.length?r[i].match(/\.js$/g)?[4,this.execJSFile(r[i]).catch(function(t){throw t})]:[3,5]:[3,10];case 4:return a.sent(),[3,7];case 5:return r[i].match(/_down\.sql$/g)?[4,this.execSQLFile(r[i]).catch(function(t){throw t})]:[3,7];case 6:a.sent(),a.label=7;case 7:return o="DELETE FROM migrations where name like '"+r[i].replace("_down.sql","_up.sql")+"'",[4,this._sequelize.query(o).catch(function(t){throw t})];case 8:a.sent(),a.label=9;case 9:return i++,[3,3];case 10:return[2,!0];case 11:return s=a.sent(),this.onError(s),[3,12];case 12:return[2]}})})},t.getInstance=function(){return void 0==t.__instance&&(t.__instance=new t),t.__instance},t.defaultOptions={database:{dialectOptions:{multipleStatements:!0}},migrationFolder:o.resolve("migrations"),extension:"js",logger:console.log},t}();e.Migration=l},function(t,e){t.exports=require("sequelize")},function(t,e){t.exports=require("path")},function(t,e){t.exports=require("moment")},function(t,e){t.exports=require("deepextend")},function(t,e){t.exports=require("fs")},function(t,e,n){"use strict";var r=this&&this.__assign||function(){return(r=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},a=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){t.done?a(t.value):new n(function(e){e(t.value)}).then(o,s)}c((r=r.apply(t,e||[])).next())})},i=this&&this.__generator||function(t,e){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=e.call(t,o)}catch(t){i=[6,t],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},o=this;Object.defineProperty(e,"__esModule",{value:!0});var s=n(7),c=n(0),u=n(8),l=n(3),f=function(t,e){var n=r({},t);return e.sqlFile&&(n=r({},n,{extension:"sql"})),e.migrationDir&&(n=r({},n,{migrationFolder:e.migrationDir})),e.databaseHost&&(n=r({},n,{database:r({},n.database,{host:e.databaseHost})})),e.databasePort&&(n=r({},n,{database:r({},n.database,{port:e.databasePort})})),e.databaseUsername&&(n=r({},n,{database:r({},n.database,{username:e.databaseUsername})})),e.databasePassword&&(n=r({},n,{database:r({},n.database,{password:e.databasePassword})})),e.databaseName&&(n=r({},n,{database:r({},n.database,{database:e.databaseName})})),n};s.version("0.1.0","-v, --version").option("-c, --config <path>","set config file.").option("-m, --migration-dir <path>",'set migration dir. [defaults:"./migrations"]').option("-db-host, --database-host <host>","set database host").option("-db-port, --database-port <host>","set database port").option("-db-user, --database-username <username>","set database username").option("-db-pass, --database-password <password>","set database password").option("-db-name, --database-name <name>","set database name").option("--sql-file","create sql files for up and down"),s.command("create [names...]").description("create a migration").action(function(t,e){c.Migration.getInstance().setup(f(u.config,s)).createMigration(t)}),s.command("up").description("update database").option("-d, --date <date>","update database to date (YYYY-MM-DDTHH:mm:ss)").action(function(t,e){return a(o,void 0,void 0,function(){var t,n;return i(this,function(r){switch(r.label){case 0:return t=void 0,e.date&&(n=l(e.date)).isValid()&&(t=n.toDate()),[4,c.Migration.getInstance().setup(f(u.config,s)).up({toDate:t})];case 1:return r.sent(),process.exit(),[2]}})})}),s.command("down").description("restore database").action(function(t,e){return a(o,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,c.Migration.getInstance().setup(f(u.config,s)).down()];case 1:return t.sent(),process.exit(),[2]}})})}),s.parse(process.argv),s.args.length||s.help()},function(t,e){t.exports=require("commander")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.config={migrationFolder:"migrations",extension:"sql",database:{dialect:"mysql",host:"localhost",username:"root",password:void 0,database:"test",define:{timestamps:!1}}}}]);